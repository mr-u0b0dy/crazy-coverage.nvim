# Supported Coverage Formats

## Overview

crazy-coverage.nvim supports 5 coverage formats:
- **LCOV** (.info, .lcov) - Text format from gcov
- **LLVM JSON** (.json) - JSON export from llvm-cov
- **Cobertura XML** (.xml) - XML format from various tools
- **GCOV** (.gcda, .gcno) - Binary format (auto-converted)
- **LLVM Profdata** (.profdata) - Binary format (auto-converted)

## LCOV (.info, .lcov)

**Generated by**: GCC gcov, genhtml, lcov tool

**Format**: Line-based text file

**Example**:
```
TN:5
SF:src/main.c
FN:10,my_function
FNDA:5,my_function
LN:10
DA:10,5
LN:11
DA:11,0
BA:11,0,1
BA:11,1,0
end_of_record
```

**Features**:
- Line coverage (DA: lines)
- Function coverage (FN/FNDA)
- Branch coverage (BA: branches)

## LLVM JSON

**Generated by**: `llvm-cov export`

**Format**: JSON

**Example**:
```json
{
  "version": "2.0.1",
  "data": [{
    "files": [{
      "filename": "src/main.cpp",
      "lines": [
        {
          "line_number": 10,
          "count": 5,
          "regions": [
            { "count": 5, "covered": true }
          ]
        }
      ]
    }]
  }]
}
```

**Features**:
- Line coverage
- Region coverage (converted to branches)

## Cobertura XML

**Generated by**: Many tools (pytest-cov, JaCoCo, etc.)

**Format**: XML

**Example**:
```xml
<coverage>
  <packages>
    <package name="sample">
      <classes>
        <class filename="src/main.c">
          <lines>
            <line number="10" hits="5"/>
            <line number="11" hits="0"/>
          </lines>
        </class>
      </classes>
    </package>
  </packages>
</coverage>
```

**Features**:
- Line coverage
- Works with both self-closing and paired XML tags

## GCOV (.gcda, .gcno)

**Generated by**: GCC with `-fprofile-arcs -ftest-coverage`

**Format**: Binary

**Auto-conversion**: Uses `lcov` tool to convert to LCOV format

**Requirements**: `lcov` must be installed

**Usage**:
```vim
" Direct load (auto-converts)
:CoverageLoad /path/to/program.gcda

" Or manually convert first
" $ lcov --directory . --capture --output-file coverage.lcov
" :CoverageLoad coverage.lcov
```

## LLVM Profdata (.profdata)

**Generated by**: Clang/LLVM with `-fprofile-instr-generate -fcoverage-mapping`

**Format**: Binary

**Auto-conversion**: Uses `llvm-cov export` to convert to JSON

**Requirements**: `llvm-profdata` and `llvm-cov` must be installed

**Usage**:
```vim
" Direct load (auto-converts)
:CoverageLoad coverage.profdata

" Or manually convert first
" $ llvm-cov export -instr-profile=coverage.profdata program > coverage.json
" :CoverageLoad coverage.json
```

## Generating Coverage Data

### GCC + GCOV

**Option 1: Generate LCOV (recommended)**
```bash
# 1. Compile with coverage flags
gcc -fprofile-arcs -ftest-coverage -o program program.c

# 2. Run program (generates .gcda files)
./program

# 3. Generate LCOV report
lcov --directory . --capture --output-file coverage.lcov

# 4. Load in Neovim
# :CoverageLoad coverage.lcov
```

**Option 2: Direct binary load**
```bash
# Steps 1-2 same as above

# 3. Load .gcda directly (plugin auto-converts)
# :CoverageLoad /path/to/program.gcda
```

### Clang/LLVM

**Option 1: Generate JSON (recommended)**
```bash
# 1. Compile with profiling
clang -fprofile-instr-generate -fcoverage-mapping -o program program.c

# 2. Run program (generates .profraw)
LLVM_PROFILE_FILE="coverage.profraw" ./program

# 3. Merge profiles
llvm-profdata merge coverage.profraw -o coverage.profdata

# 4. Export to JSON
llvm-cov export -instr-profile=coverage.profdata program > coverage.json

# 5. Load in Neovim
# :CoverageLoad coverage.json
```

**Option 2: Direct profdata load**
```bash
# Steps 1-3 same as above

# 4. Load .profdata directly (plugin auto-converts)
# :CoverageLoad coverage.profdata
```

### CMake Integration

```cmake
# Enable coverage for GCC
if(CMAKE_BUILD_TYPE MATCHES Coverage)
  set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -fprofile-arcs -ftest-coverage")
  set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fprofile-arcs -ftest-coverage")
  set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -lgcov")
endif()

# Enable coverage for Clang
if(CMAKE_BUILD_TYPE MATCHES Coverage AND CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -fprofile-instr-generate -fcoverage-mapping")
  set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fprofile-instr-generate -fcoverage-mapping")
endif()
```

### Makefile Integration

```makefile
# Coverage flags
CFLAGS_COV = -fprofile-arcs -ftest-coverage
LDFLAGS_COV = -lgcov

# Coverage target
coverage:
	$(CC) $(CFLAGS) $(CFLAGS_COV) -o program program.c $(LDFLAGS_COV)
	./program
	lcov --directory . --capture --output-file coverage.lcov
	@echo "Load coverage.lcov in Neovim"

.PHONY: coverage
```

## Format Selection Priority

When auto-detecting format, the plugin uses this priority:

1. **File extension** (`.lcov`, `.json`, `.xml`, `.gcda`, `.profdata`)
2. **Content inspection** (for extensionless files)
   - Lines starting with `TN:`, `FN:`, `DA:` → LCOV
   - Lines starting with `{` → LLVM JSON

## Tips

### Filtering Coverage

Use `lcov` to filter unwanted files:
```bash
# Exclude system headers and test files
lcov --directory . --capture --output-file coverage_all.lcov
lcov --remove coverage_all.lcov '/usr/*' '*/test/*' --output-file coverage.lcov
```

### Combining Multiple Runs

```bash
# GCC: accumulates in .gcda files automatically
./program --test-suite-1
./program --test-suite-2
lcov --directory . --capture --output-file coverage.lcov

# LLVM: merge .profraw files
llvm-profdata merge run1.profraw run2.profraw -o coverage.profdata
```

### HTML Reports

Generate browsable HTML alongside Neovim usage:
```bash
# From LCOV
genhtml coverage.lcov --output-directory coverage_html

# From LLVM
llvm-cov show -instr-profile=coverage.profdata program -format=html > coverage.html
```
